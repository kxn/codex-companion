<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Logs - Codex Companion</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<main>
<h1>Logs</h1>
<nav><a href="index.html">Accounts</a> | <a href="logs.html">Logs</a></nav>
<div>
  <button id="prevPage">Prev</button>
  <span id="pageInfo"></span>
  <button id="nextPage">Next</button>
  <button id="toggleRefresh">Start Auto Refresh</button>
</div>
<table id="logs">
  <thead>
    <tr><th>ID</th><th>Time</th><th>Account</th><th>Method</th><th>URL</th><th>Status</th><th>Error</th><th>Details</th></tr>
  </thead>
  <tbody></tbody>
</table>
<dialog id="logModal">
  <button id="closeModal">X</button>
  <pre id="logDetail"></pre>
</dialog>
</main>
<script>
let page = 1;
let auto = false;
let timer;
let hasMore = false;
async function loadLogs() {
  const res = await fetch(`/admin/api/logs?page=${page}`);
  const data = await res.json();
  const logs = data.logs;
  hasMore = data.has_more;
  page = data.page;
  const tbody = document.querySelector('#logs tbody');
  tbody.innerHTML = '';
  logs.forEach(l => {
    const tr = document.createElement('tr');
    const time = new Date(l.Time).toLocaleString();
    tr.innerHTML = `<td>${l.ID}</td><td>${time}</td><td>${l.AccountID}</td><td>${l.Method}</td><td>${l.URL}</td><td>${l.Status}</td><td>${l.Error || ''}</td>`;
    const td = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = 'Details';
    btn.onclick = () => {
      document.getElementById('logDetail').textContent = JSON.stringify(l, null, 2);
      document.getElementById('logModal').showModal();
    };
    td.appendChild(btn);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent = `Page ${page}`;
  document.getElementById('prevPage').disabled = page <= 1;
  document.getElementById('nextPage').disabled = !hasMore;
}

document.getElementById('prevPage').onclick = () => { if(page>1){ page--; loadLogs(); }};
document.getElementById('nextPage').onclick = () => { if(hasMore){ page++; loadLogs(); }};
const refreshBtn = document.getElementById('toggleRefresh');
refreshBtn.onclick = () => {
  auto = !auto;
  if(auto){
    timer = setInterval(loadLogs, 5000);
    refreshBtn.textContent = 'Stop Auto Refresh';
  } else {
    clearInterval(timer);
    refreshBtn.textContent = 'Start Auto Refresh';
  }
};
document.getElementById('closeModal').onclick = () => document.getElementById('logModal').close();
loadLogs();
</script>
</body>
</html>
