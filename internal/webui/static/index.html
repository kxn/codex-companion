<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Codex Companion</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<main>
<h1>Codex Companion</h1>
<nav><a href="index.html">Accounts</a> | <a href="logs.html">Logs</a></nav>

<section>
  <h2>Add API Key Account</h2>
  <form id="apiKeyForm">
    <input name="name" placeholder="Name" required>
    <input name="api_key" placeholder="API Key" required>
    <input name="base_url" placeholder="Base URL">
    <button type="submit">Add</button>
  </form>

  <h2>Add ChatGPT Account</h2>
  <button id="uploadBtn">Import auth.json</button>
  <button id="importBtn">Import local auth.json</button>
</section>

<section>
  <h2>Accounts</h2>
  <table id="accounts">
    <thead>
      <tr><th>ID</th><th>Type</th><th>Name</th><th>API Key</th><th>Refresh Token</th><th>Access Token</th><th>Priority</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

</main>

<dialog id="editDialog">
  <form id="editForm">
    <input type="hidden" name="id">
    <input name="name" placeholder="Name" required>
    <div id="apiKeyGroup">
      <input name="api_key" placeholder="API Key">
      <input name="base_url" placeholder="Base URL">
    </div>
    <div id="chatgptGroup">
      <input name="refresh_token" placeholder="Refresh Token">
      <input name="account_id" placeholder="Account ID">
    </div>
    <menu>
      <button value="cancel">Cancel</button>
      <button id="editSave" value="default">Save</button>
    </menu>
  </form>
</dialog>

<script>
let accountsCache = [];
async function loadAccounts() {
  try {
    const res = await fetch('/admin/api/accounts');
    const accounts = await res.json();
    accountsCache = accounts;
    const tbody = document.querySelector('#accounts tbody');
    tbody.innerHTML = '';
    const shorten = s => s ? (s.length > 10 ? s.slice(0,10) + '...' : s) : '';
    accounts.forEach(a => {
      const tr = document.createElement('tr');
      tr.draggable = true;
      tr.dataset.id = a.id;
      tr.addEventListener('dragstart', dragStart);
      tr.addEventListener('dragover', dragOver);
      tr.addEventListener('drop', drop);
      const type = a.type === 0 ? 'API Key' : 'ChatGPT';
      const id = a.account_id || a.id;
      tr.innerHTML = `<td>${id}</td><td>${type}</td><td>${a.name}</td><td>${shorten(a.api_key)}</td><td>${shorten(a.refresh_token)}</td><td>${shorten(a.access_token)}</td><td>${a.priority}</td>`;
      const actions = document.createElement('td');
      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.onclick = async () => {
        const resp = await fetch(`/admin/api/accounts/${a.id}`, {method: 'DELETE'});
        if (!resp.ok) {
          alert('Delete failed ' + resp.status);
        }
        loadAccounts();
      };
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => openEdit(a);
      actions.appendChild(editBtn);
      actions.appendChild(del);
      tr.appendChild(actions);
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error('Load accounts error', e);
  }
}

document.getElementById('apiKeyForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = new FormData(e.target);
  try {
    const resp = await fetch('/admin/api/accounts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        type: 'api_key',
        name: f.get('name'),
        api_key: f.get('api_key'),
        base_url: f.get('base_url')
      })
    });
    if (!resp.ok) {
      alert('Add API key account failed: ' + (await resp.text()));
    }
  } catch (e) {
    console.error('Add API key account error', e);
  }
  e.target.reset();
  loadAccounts();
};

const uploadInput = document.createElement('input');
uploadInput.type = 'file';
uploadInput.accept = 'application/json';
uploadInput.onchange = async () => {
  const file = uploadInput.files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append('file', file);
  try {
    const resp = await fetch('/admin/api/accounts/import/upload', {method: 'POST', body: fd});
    if (!resp.ok) {
      alert('Import auth.json failed: ' + (await resp.text()));
    }
  } catch (e) {
    console.error('Import uploaded auth.json error', e);
  }
  loadAccounts();
};

document.getElementById('uploadBtn').onclick = () => uploadInput.click();

document.getElementById('importBtn').onclick = async () => {
  try {
    const resp = await fetch('/admin/api/accounts/import', {method: 'POST'});
    if (!resp.ok) {
      alert('Import local auth.json failed: ' + (await resp.text()));
    }
  } catch (e) {
    console.error('Import local auth.json error', e);
  }
  loadAccounts();
};

let dragged;
function dragStart(e){
  dragged = this;
  e.dataTransfer.effectAllowed = 'move';
}
function dragOver(e){
  e.preventDefault();
}
function drop(e){
  e.preventDefault();
  if(dragged !== this){
    const tbody = this.parentNode;
    tbody.insertBefore(dragged, this);
    saveOrder();
  }
}
async function saveOrder(){
  const rows = document.querySelectorAll('#accounts tbody tr');
  for(let i=0;i<rows.length;i++){
    const id = Number(rows[i].dataset.id);
    const acc = accountsCache.find(a => a.id === id);
    if(!acc) continue;
    acc.priority = i;
    await fetch(`/admin/api/accounts/${id}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(acc)
    });
  }
  loadAccounts();
}

function load() {
  loadAccounts();
}

function openEdit(a) {
  const dlg = document.getElementById('editDialog');
  const form = document.getElementById('editForm');
  form.id.value = a.id;
  form.name.value = a.name;
  form.api_key.value = a.api_key || '';
  form.base_url.value = a.base_url || '';
  form.refresh_token.value = a.refresh_token || '';
  form.account_id.value = a.account_id || '';
  document.getElementById('apiKeyGroup').style.display = a.type === 0 ? '' : 'none';
  document.getElementById('chatgptGroup').style.display = a.type === 0 ? 'none' : '';
  dlg.showModal();
}

document.getElementById('editForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = new FormData(e.target);
  const id = f.get('id');
  const acc = accountsCache.find(a => a.id == id);
  acc.name = f.get('name');
  if (acc.type === 0) {
    acc.api_key = f.get('api_key');
    acc.base_url = f.get('base_url');
  } else {
    acc.refresh_token = f.get('refresh_token');
    acc.account_id = f.get('account_id');
  }
  const resp = await fetch(`/admin/api/accounts/${id}`, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(acc)
  });
  if (!resp.ok) {
    alert('Update failed ' + resp.status);
  }
  document.getElementById('editDialog').close();
  loadAccounts();
};

load();
</script>
</body>
</html>
