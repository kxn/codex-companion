<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Codex Companion</title>
</head>
<body>
<h1>Codex Companion</h1>
<nav><a href="index.html">Accounts</a> | <a href="logs.html">Logs</a></nav>

<section>
  <h2>Add API Key Account</h2>
  <form id="apiKeyForm">
    <input name="name" placeholder="Name" required>
    <input name="api_key" placeholder="API Key" required>
    <input name="priority" type="number" value="0">
    <button type="submit">Add</button>
  </form>

  <h2>Add ChatGPT Account</h2>
  <form id="chatgptForm">
    <input name="name" placeholder="Name" required>
    <input name="refresh_token" placeholder="Refresh Token" required>
    <input name="priority" type="number" value="0">
    <button type="submit">Add</button>
  </form>
  <button id="importBtn">Import auth.json</button>
</section>

<section>
  <h2>Accounts</h2>
  <table id="accounts">
    <thead>
      <tr><th>ID</th><th>Type</th><th>Name</th><th>API Key</th><th>Refresh Token</th><th>Access Token</th><th>Priority</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
async function loadAccounts() {
  try {
    const res = await fetch('/admin/api/accounts');
    const accounts = await res.json();
    const tbody = document.querySelector('#accounts tbody');
    tbody.innerHTML = '';
    const shorten = s => s ? (s.length > 10 ? s.slice(0,10) + '...' : s) : '';
    accounts.forEach(a => {
      const tr = document.createElement('tr');
      const type = a.type === 0 ? 'API Key' : 'ChatGPT';
      const id = a.account_id || a.id;
      tr.innerHTML = `<td>${id}</td><td>${type}</td><td>${a.name}</td><td>${shorten(a.api_key)}</td><td>${shorten(a.refresh_token)}</td><td>${shorten(a.access_token)}</td><td>${a.priority}</td>`;
      const actions = document.createElement('td');
      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.onclick = async () => {
        const resp = await fetch(`/admin/api/accounts/${a.id}`, {method: 'DELETE'});
        if (!resp.ok) {
          alert('Delete failed ' + resp.status);
        }
        loadAccounts();
      };
      actions.appendChild(del);
      tr.appendChild(actions);
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error('Load accounts error', e);
  }
}

document.getElementById('apiKeyForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = new FormData(e.target);
  try {
    const resp = await fetch('/admin/api/accounts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        type: 'api_key',
        name: f.get('name'),
        api_key: f.get('api_key'),
        priority: Number(f.get('priority') || 0)
      })
    });
    if (!resp.ok) {
      alert('Add API key account failed: ' + (await resp.text()));
    }
  } catch (e) {
    console.error('Add API key account error', e);
  }
  e.target.reset();
  loadAccounts();
};

document.getElementById('chatgptForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = new FormData(e.target);
  try {
    const resp = await fetch('/admin/api/accounts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        type: 'chatgpt',
        name: f.get('name'),
        refresh_token: f.get('refresh_token'),
        priority: Number(f.get('priority') || 0)
      })
    });
    if (!resp.ok) {
      alert('Add ChatGPT account failed: ' + (await resp.text()));
    }
  } catch (e) {
    console.error('Add ChatGPT account error', e);
  }
  e.target.reset();
  loadAccounts();
};

document.getElementById('importBtn').onclick = async () => {
  try {
    const resp = await fetch('/admin/api/accounts/import', {method: 'POST'});
    if (!resp.ok) {
      console.error('Import auth.json failed', resp.status);
    }
  } catch (e) {
    console.error('Import auth.json error', e);
  }
  loadAccounts();
};

function load() {
  loadAccounts();
}

load();
</script>
</body>
</html>
