<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Codex Companion</title>
</head>
<body>
<h1>Codex Companion</h1>

<section>
  <h2>Add API Key Account</h2>
  <form id="apiKeyForm">
    <input name="name" placeholder="Name" required>
    <input name="api_key" placeholder="API Key" required>
    <input name="priority" type="number" value="0">
    <button type="submit">Add</button>
  </form>

  <h2>Add ChatGPT Account</h2>
  <form id="chatgptForm">
    <input name="name" placeholder="Name" required>
    <input name="refresh_token" placeholder="Refresh Token" required>
    <input name="priority" type="number" value="0">
    <button type="submit">Add</button>
  </form>
  <button id="importBtn">Import auth.json</button>
</section>

<section>
  <h2>Accounts</h2>
  <div id="accounts"></div>
</section>

<section>
  <h2>Logs</h2>
  <pre id="logs"></pre>
</section>

<script>
async function loadAccounts() {
  try {
    const res = await fetch('/admin/api/accounts');
    const accounts = await res.json();
    console.debug('Loaded accounts', accounts);
    const container = document.getElementById('accounts');
    container.innerHTML = '';
    accounts.forEach(a => {
      const div = document.createElement('div');
      div.textContent = `${a.id}: ${a.name} (priority ${a.priority})`;
      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.onclick = async () => {
        const resp = await fetch(`/admin/api/accounts/${a.id}`, {method: 'DELETE'});
        if (!resp.ok) {
          console.error('Delete failed', resp.status);
        }
        loadAccounts();
      };
      div.appendChild(del);
      container.appendChild(div);
    });
  } catch (e) {
    console.error('Load accounts error', e);
  }
}

async function loadLogs() {
  const res = await fetch('/admin/api/logs');
  const logs = await res.json();
  document.getElementById('logs').textContent = JSON.stringify(logs, null, 2);
}

document.getElementById('apiKeyForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = new FormData(e.target);
  try {
    const resp = await fetch('/admin/api/accounts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        type: 'api_key',
        name: f.get('name'),
        api_key: f.get('api_key'),
        priority: Number(f.get('priority') || 0)
      })
    });
    if (!resp.ok) {
      console.error('Add API key account failed', resp.status);
    }
  } catch (e) {
    console.error('Add API key account error', e);
  }
  e.target.reset();
  loadAccounts();
};

document.getElementById('chatgptForm').onsubmit = async (e) => {
  e.preventDefault();
  const f = new FormData(e.target);
  try {
    const resp = await fetch('/admin/api/accounts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        type: 'chatgpt',
        name: f.get('name'),
        refresh_token: f.get('refresh_token'),
        priority: Number(f.get('priority') || 0)
      })
    });
    if (!resp.ok) {
      console.error('Add ChatGPT account failed', resp.status);
    }
  } catch (e) {
    console.error('Add ChatGPT account error', e);
  }
  e.target.reset();
  loadAccounts();
};

document.getElementById('importBtn').onclick = async () => {
  try {
    const resp = await fetch('/admin/api/accounts/import', {method: 'POST'});
    if (!resp.ok) {
      console.error('Import auth.json failed', resp.status);
    }
  } catch (e) {
    console.error('Import auth.json error', e);
  }
  loadAccounts();
};

function load() {
  loadAccounts();
  loadLogs();
}

load();
</script>
</body>
</html>
